<!DOCTYPE html>
<html lang="en">
  <%- include('./../components/header') %>

  <body class="bg-gray-100 min-h-screen">
    <%- include('./../components/navbar') %>
    <div class="flex flex-col items-center p-6">
      <h1 class="text-3xl font-bold mb-6">PDF Splitter</h1>

      <div class="w-full max-w-3xl bg-white p-6 rounded-lg shadow-lg">
        <!-- Upload -->
        <label class="block mb-4">
          <span class="text-gray-700 font-semibold mb-1 block"
            >Select PDF file:</span
          >
          <input
            type="file"
            id="pdfInput"
            accept="application/pdf"
            class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
          />
        </label>

        <!-- Preview of uploaded PDF -->
        <div id="originalPreviewContainer" class="mb-6 hidden">
          <p class="mb-2 font-semibold text-gray-800">Original PDF Preview:</p>
          <iframe
            id="originalPreview"
            class="w-full h-64 border rounded"
            frameborder="0"
          ></iframe>
        </div>

        <!-- Page input -->
        <label class="block mb-4">
          <span class="text-gray-700 font-semibold mb-1 block"
            >Pages to split (e.g. 1-3,5,7):</span
          >
          <input
            type="text"
            id="pagesInput"
            placeholder="Enter pages or ranges"
            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <!-- Buttons -->
        <div class="flex gap-4 mb-6">
          <button
            id="splitBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
            disabled
          >
            Split PDF
          </button>
          <button
            id="clearBtn"
            class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500"
          >
            Clear
          </button>
        </div>

        <!-- Result Preview -->
        <div id="resultPreviewContainer" class="mb-6 hidden">
          <p class="mb-2 font-semibold text-gray-800">Result PDF Preview:</p>
          <iframe
            id="resultPreview"
            class="w-full h-64 border rounded"
            frameborder="0"
          ></iframe>
          <a
            id="downloadLink"
            href="#"
            download="split.pdf"
            class="inline-block mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
            >Download Result</a
          >
        </div>
      </div>
    </div>
    <script>
      const pdfInput = document.getElementById("pdfInput");
      const originalPreviewContainer = document.getElementById(
        "originalPreviewContainer"
      );
      const originalPreview = document.getElementById("originalPreview");
      const pagesInput = document.getElementById("pagesInput");
      const splitBtn = document.getElementById("splitBtn");
      const clearBtn = document.getElementById("clearBtn");
      const resultPreviewContainer = document.getElementById(
        "resultPreviewContainer"
      );
      const resultPreview = document.getElementById("resultPreview");
      const downloadLink = document.getElementById("downloadLink");

      let originalFile = null;

      pdfInput.addEventListener("change", () => {
        const file = pdfInput.files[0];
        if (file && file.type === "application/pdf") {
          originalFile = file;
          const url = URL.createObjectURL(file);
          originalPreview.src = url;
          originalPreviewContainer.classList.remove("hidden");
          splitBtn.disabled = false;

          // Clear previous result
          resultPreviewContainer.classList.add("hidden");
          resultPreview.src = "";
          downloadLink.href = "#";
        } else {
          originalFile = null;
          originalPreviewContainer.classList.add("hidden");
          originalPreview.src = "";
          splitBtn.disabled = true;
        }
      });

      splitBtn.addEventListener("click", async () => {
        if (!originalFile) return alert("Please select a PDF file first.");
        if (!pagesInput.value.trim())
          return alert("Please enter pages to split.");

        splitBtn.disabled = true;
        splitBtn.textContent = "Processing...";

        try {
          const formData = new FormData();
          formData.append("file", originalFile);
          formData.append("pages", pagesInput.value.trim());

          const response = await fetch("/api/pdf-splitter", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error(`Server error: ${response.status}`);

          // Expecting PDF blob back
          const blob = await response.blob();
          if (blob.type !== "application/pdf")
            throw new Error("Invalid response file type");

          const resultUrl = URL.createObjectURL(blob);
          resultPreview.src = resultUrl;
          downloadLink.href = resultUrl;

          resultPreviewContainer.classList.remove("hidden");
        } catch (error) {
          alert("Error splitting PDF: " + error.message);
        } finally {
          splitBtn.disabled = false;
          splitBtn.textContent = "Split PDF";
        }
      });

      clearBtn.addEventListener("click", () => {
        pdfInput.value = "";
        pagesInput.value = "";
        originalFile = null;

        originalPreview.src = "";
        originalPreviewContainer.classList.add("hidden");

        resultPreview.src = "";
        resultPreviewContainer.classList.add("hidden");
        downloadLink.href = "#";

        splitBtn.disabled = true;
      });
    </script>
    <%- include('./../components/footer') %>
  </body>
</html>
